---
title: "Problem Set 4"
author: "Neil Khurana"
date: "February 25, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(tidyverse)
library(readr)
library(ggplot2)
library(lubridate)
library(readxl)
library(janitor)
library(ggridges)
library(viridis)
library(gt)
```

## Question 1

```{r, include = FALSE}
x <- read_csv("ps_4_elections-poll-nc09-3.csv")
```
There were `r x %>% filter(response == "Dem") %>% nrow()` respondents who supported the Democratic candidate.

There were `r x %>% filter(response == "Rep") %>% nrow() - x %>% filter(response == "Und") %>% nrow()` more respondents who favored the Republican candidate than who were Undecided.

There are two gender variables (`gender` and `gender_combined`). There are `r x %>% filter(gender != "[DO NOT READ] Don't know/Refused", gender_combined != "[DO NOT READ] Don't know/Refused", gender != gender_combined) %>% nrow()` individuals for whom these variables have different values.

There are `r x %>% filter(race_eth == "White") %>% filter(race_eth != file_race_black) %>% nrow()` respondents listed as “White” under `race_eth` who are not listed as “White” under `file_race_black`.

```{r, echo = FALSE}
min_r <- x %>% 
   filter(response == "Rep") %>%
    arrange(timestamp) %>% 
    slice(1) %>% 
  select(timestamp)
 

min_d <- x %>% 
  filter(response == "Dem") %>% 
  arrange(timestamp) %>% 
  slice(1) %>% 
  select(timestamp)
```

The first `response` of Rep came `r round(as.numeric(min_r-min_d), digits = 0)` minutes (rounded to the nearest minute) before the first `response` of Dem.

## Question 2

```{r, echo = FALSE, message = FALSE}
y <- x %>% 
  filter(!is.na(response)) %>% 
  select(response, race_eth, final_weight) %>% 
  group_by(race_eth, response) %>% 
  summarize(total = sum(final_weight)) %>%   
  filter(race_eth != "[DO NOT READ] Don't know/Refused") %>% 
  spread(key =  response, value = total, fill = 0) %>%  
  mutate(all = Dem + Rep + Und + `3`) %>% 
  mutate(Dem = Dem / all) %>% 
  mutate(Rep = Rep / all) %>% 
  mutate(Und = Und / all) %>% 
  select(-all, -`3`) %>%
  ungroup() %>% 
  mutate(race_eth = factor(race_eth, levels = c("White", "Black", "Hispanic", "Asian", "Other"))) %>%
  arrange(race_eth) %>% 
  na_if(0) %>%
  gt() %>% 
  tab_header(
    title = "Polling Results in North Carolina 9th Congressional District") %>% 
  tab_source_note(source_note = "Source: New York Times Upshot/Siena College 2018 Live Polls"
  ) %>% 
  
  cols_label(
    race_eth = "Race",
    Dem = "Democrat",
    Rep = "Republican",
    Und = "Undecided"
  ) %>%
  
  
  fmt_percent(columns = vars(Dem, Rep, Und),
              decimals = 0) %>% 
  
  fmt_missing(columns = vars(Und), rows = 4) 
y


```

## Question 3

```{r, echo = FALSE, message = FALSE}
e <- read_csv("ps_4_elections-poll-nc09-3.csv") %>%
  select(educ, final_weight) %>% 
  filter(educ != "[DO NOT READ] Refused") %>%  
  ## Proper filters are put in place to get rid of NAs and meet the undergrad specifications
  ## We filter out to only the course departments that we are interested in for this graph
  
  mutate(educ = factor(educ, levels = c("Grade school", "High school",
                                        "Some college or trade school", "Bachelors' degree",
                                        "Graduate or Professional Degree"))) %>%
  ggplot(aes(x = educ, y = final_weight)) +
  geom_violin() +
  geom_jitter(alpha = 0.4, width = 0.2) +
  coord_flip() +
  ## Sets the axis values and the graph type
  ## Proper labeling of both axis
  ## Graph is filled with color, legend is removed, and log scaling is used
  labs(title = "More Educated Matter Less in North Carolina 9th",
           subtitle = "Poll gives more weight to people who are less likely to participate in polls",
         x = NULL,
         y = "Weight Given to Respondent in Calculating Poll Results",
           caption = "New York Times Upshot/Siena College 2018 live polls") 
e
```

## Question 4

```{r, echo = FALSE, message = FALSE}
f <- read_csv("ps_4_elections-poll-nc09-3.csv") %>%
  filter(!is.na(response)) %>% 
  select(response, gender, final_weight) %>% 
  group_by(gender, response) %>% 
  summarize(total = sum(final_weight)) %>%   
  filter(gender != "[DO NOT READ] Don't know/Refused") %>% 
  spread(key =  response, value = total, fill = 0) %>%  
  mutate(all = Dem + Rep + Und + `3`) %>% 
  mutate(Dem = Dem / all * 100) %>% 
  mutate(Rep = Rep / all * 100) %>% 
  mutate(Und = Und / all * 100) %>% 
  select(-all, -`3`) %>%
  gather(party, pct, Dem:Und) 
p <- ggplot(f, aes(x = party, y = pct, fill = party))
p + geom_col(position = "dodge2") +
    labs(x = NULL, y = "pct", fill = "party") +
    guides(fill = FALSE) + 
    coord_flip() + 
    facet_grid(~ gender) +
    scale_fill_manual(values = c("blue", "red", "green")) +
    ylab("Percentage of Voters") +
    xlab("Political Party") +
    theme(plot.title = element_text(hjust = 0.5)) +
    scale_y_continuous(limits=c(0, 60)) +
    ggtitle("Political Party Support Separated by Gender in NC 9th")
  
```


